import"./modulepreload-polyfill-B5Qt9EMX.js";var C=class extends Error{constructor(e,t){super(e,t),this.name="OTPError"}},vt=class extends C{constructor(t){super(t),this.name="SecretError"}},wn=class extends vt{constructor(t,n){super(`Secret must be at least ${t} bytes (${t*8} bits), got ${n} bytes`),this.name="SecretTooShortError"}},yn=class extends vt{constructor(t,n){super(`Secret must not exceed ${t} bytes, got ${n} bytes`),this.name="SecretTooLongError"}},Ye=class extends C{constructor(t){super(t),this.name="CounterError"}},bn=class extends Ye{constructor(){super("Counter must be non-negative"),this.name="CounterNegativeError"}},dt=class extends Ye{constructor(){super("Counter exceeds maximum safe integer value"),this.name="CounterOverflowError"}},vn=class extends Ye{constructor(){super("Counter must be a finite integer"),this.name="CounterNotIntegerError"}},Et=class extends C{constructor(t){super(t),this.name="TimeError"}},En=class extends Et{constructor(){super("Time must be non-negative"),this.name="TimeNegativeError"}},xn=class extends Et{constructor(){super("Time must be a finite number"),this.name="TimeNotFiniteError"}},xt=class extends C{constructor(e){super(e),this.name="PeriodError"}},An=class extends xt{constructor(t){super(`Period must be at least ${t} second(s)`),this.name="PeriodTooSmallError"}},Ln=class extends xt{constructor(t){super(`Period must not exceed ${t} seconds`),this.name="PeriodTooLargeError"}},At=class extends C{constructor(t){super(t),this.name="TokenError"}},kn=class extends At{constructor(e,t){super(`Token must be ${e} digits, got ${t}`),this.name="TokenLengthError"}},Sn=class extends At{constructor(){super("Token must contain only digits"),this.name="TokenFormatError"}},Lt=class extends C{constructor(e,t){super(e,t),this.name="CryptoError"}},fe=class extends Lt{constructor(t,n){super(`HMAC computation failed: ${t}`,n),this.name="HMACError"}},Cn=class extends Lt{constructor(t,n){super(`Random byte generation failed: ${t}`,n),this.name="RandomBytesError"}},qe=class extends C{constructor(e){super(e),this.name="CounterToleranceError"}},Tn=class extends qe{constructor(t,n){super(`Counter tolerance validation failed: total checks (${n}) exceeds MAX_WINDOW (${t})`),this.name="CounterToleranceTooLargeError"}},In=class extends qe{constructor(){super("Counter tolerance cannot contain negative values"),this.name="CounterToleranceNegativeError"}},Je=class extends C{constructor(e){super(e),this.name="EpochToleranceError"}},Pn=class extends Je{constructor(){super("Epoch tolerance cannot contain negative values"),this.name="EpochToleranceNegativeError"}},$n=class extends Je{constructor(e,t){super(`Epoch tolerance must not exceed ${e} seconds, got ${t}. Large tolerances can cause performance issues.`),this.name="EpochToleranceTooLargeError"}},kt=class extends C{constructor(t){super(t),this.name="PluginError"}},Mn=class extends kt{constructor(){super("Crypto plugin is required."),this.name="CryptoPluginMissingError"}},Dn=class extends kt{constructor(){super("Base32 plugin is required."),this.name="Base32PluginMissingError"}},V=class extends C{constructor(e){super(e),this.name="ConfigurationError"}},Nn=class extends V{constructor(){super("Secret is required. Use generateSecret() to create one, or provide via { secret: 'YOUR_BASE32_SECRET' }"),this.name="SecretMissingError"}},Qe=class extends C{constructor(e){super(e),this.name="AfterTimeStepError"}},_n=class extends Qe{constructor(){super("afterTimeStep must be >= 0"),this.name="AfterTimeStepNegativeError"}},Bn=class extends Qe{constructor(){super("Invalid afterTimeStep: non-integer value"),this.name="AfterTimeStepNotIntegerError"}},On=class extends Qe{constructor(){super("Invalid afterTimeStep: cannot be greater than current time step plus window"),this.name="AfterTimeStepRangeExceededError"}},Hn=new TextEncoder;new TextDecoder;var Rn=16,Un=64,Fn=20,jn=1,Gn=3600,Wn=30,Xn=Number.MAX_SAFE_INTEGER,Vn=99,St=Symbol("otplib.guardrails.override");function Y(e,t,n){if(typeof t!="number"||!Number.isSafeInteger(t))throw new V(`Guardrail '${e}' must be a safe integer`);if(t<n)throw new V(`Guardrail '${e}' must be >= ${n}`)}var z=Object.freeze({MIN_SECRET_BYTES:Rn,MAX_SECRET_BYTES:Un,MIN_PERIOD:jn,MAX_PERIOD:Gn,MAX_COUNTER:Xn,MAX_WINDOW:Vn,[St]:!1});function ae(e){if(!e)return z;e.MIN_SECRET_BYTES!==void 0&&Y("MIN_SECRET_BYTES",e.MIN_SECRET_BYTES,1),e.MAX_SECRET_BYTES!==void 0&&Y("MAX_SECRET_BYTES",e.MAX_SECRET_BYTES,1),e.MIN_PERIOD!==void 0&&Y("MIN_PERIOD",e.MIN_PERIOD,1),e.MAX_PERIOD!==void 0&&Y("MAX_PERIOD",e.MAX_PERIOD,1),e.MAX_COUNTER!==void 0&&Y("MAX_COUNTER",e.MAX_COUNTER,0),e.MAX_WINDOW!==void 0&&Y("MAX_WINDOW",e.MAX_WINDOW,1);let t={...z,...e};if(t.MIN_SECRET_BYTES>t.MAX_SECRET_BYTES)throw new V("Guardrail 'MIN_SECRET_BYTES' must be <= 'MAX_SECRET_BYTES'");if(t.MIN_PERIOD>t.MAX_PERIOD)throw new V("Guardrail 'MIN_PERIOD' must be <= 'MAX_PERIOD'");return Object.freeze({...t,[St]:!0})}function $e(e,t=z){if(e.length<t.MIN_SECRET_BYTES)throw new wn(t.MIN_SECRET_BYTES,e.length);if(e.length>t.MAX_SECRET_BYTES)throw new yn(t.MAX_SECRET_BYTES,e.length)}function Ct(e,t=z){if(typeof e=="number"){if(!Number.isFinite(e)||!Number.isInteger(e))throw new vn;if(!Number.isSafeInteger(e))throw new dt}let n=typeof e=="bigint"?e:BigInt(e);if(n<0n)throw new bn;if(n>BigInt(t.MAX_COUNTER))throw new dt}function Tt(e){if(!Number.isFinite(e))throw new xn;if(e<0)throw new En}function It(e,t=z){if(!Number.isInteger(e)||e<t.MIN_PERIOD)throw new An(t.MIN_PERIOD);if(e>t.MAX_PERIOD)throw new Ln(t.MAX_PERIOD)}function Pt(e,t){if(e.length!==t)throw new kn(t,e.length);if(!/^\d+$/.test(e))throw new Sn}function zn(e,t=z){let[n,r]=Dt(e);if(!Number.isSafeInteger(n)||!Number.isSafeInteger(r))throw new qe("Counter tolerance values must be safe integers");if(n<0||r<0)throw new In;let o=n+r+1;if(o>t.MAX_WINDOW)throw new Tn(t.MAX_WINDOW,o)}function Kn(e,t=Wn,n=z){let[r,o]=Array.isArray(e)?e:[e,e];if(!Number.isSafeInteger(r)||!Number.isSafeInteger(o))throw new Je("Epoch tolerance values must be safe integers");if(r<0||o<0)throw new Pn;let s=(n.MAX_WINDOW-1)*t,a=r+o;if(a>s)throw new $n(s,a)}function Yn(e){let t=typeof e=="bigint"?e:BigInt(e),n=new ArrayBuffer(8);return new DataView(n).setBigUint64(0,t,!1),new Uint8Array(n)}function $t(e){let t=e[e.length-1]&15;return(e[t]&127)<<24|e[t+1]<<16|e[t+2]<<8|e[t+3]}function Mt(e,t){let n=10**t;return(e%n).toString().padStart(t,"0")}function qn(e,t){return e.length===t.length}function Jn(e,t){let n=ut(e),r=ut(t);if(!qn(n,r))return!1;let o=0;for(let s=0;s<n.length;s++)o|=n[s]^r[s];return o===0}function ut(e){return typeof e=="string"?Hn.encode(e):e}function Me(e,t){return typeof e=="string"?(Nt(t),t.decode(e)):e}function Qn(e){let{crypto:t,base32:n,length:r=Fn}=e;ie(t),Nt(n);let o=t.randomBytes(r);return n.encode(o,{padding:!1})}function Dt(e=0){return Array.isArray(e)?e:[0,e]}function Zn(e=0){return Array.isArray(e)?e:[e,e]}function ie(e){if(!e)throw new Mn}function Nt(e){if(!e)throw new Dn}function De(e){if(!e)throw new Nn}var er=class{constructor(e){this.crypto=e}get plugin(){return this.crypto}async hmac(e,t,n){try{let r=this.crypto.hmac(e,t,n);return r instanceof Promise?await r:r}catch(r){let o=r instanceof Error?r.message:String(r);throw new fe(o,{cause:r})}}hmacSync(e,t,n){try{let r=this.crypto.hmac(e,t,n);if(r instanceof Promise)throw new fe("Crypto plugin does not support synchronous HMAC operations");return r}catch(r){if(r instanceof fe)throw r;let o=r instanceof Error?r.message:String(r);throw new fe(o,{cause:r})}}randomBytes(e){try{return this.crypto.randomBytes(e)}catch(t){let n=t instanceof Error?t.message:String(t);throw new Cn(n,{cause:t})}}};function tr(e){return new er(e)}function _t(e){let{type:t,label:n,params:r}=e,o=n.split(":").map(c=>encodeURIComponent(c)).join(":"),s=`otpauth://${t}/${o}?`,a=[];return r.secret&&a.push(`secret=${encodeURIComponent(r.secret)}`),r.issuer&&a.push(`issuer=${encodeURIComponent(r.issuer)}`),r.algorithm&&r.algorithm!=="sha1"&&a.push(`algorithm=${r.algorithm.toUpperCase()}`),r.digits&&r.digits!==6&&a.push(`digits=${r.digits}`),t==="hotp"&&r.counter!==void 0&&a.push(`counter=${r.counter}`),t==="totp"&&r.period!==void 0&&r.period!==30&&a.push(`period=${r.period}`),s+=a.join("&"),s}function nr(e){let{issuer:t,label:n,secret:r,algorithm:o="sha1",digits:s=6,period:a=30}=e,c=t?`${t}:${n}`:n;return _t({type:"totp",label:c,params:{secret:r,issuer:t,algorithm:o,digits:s,period:a}})}function rr(e){let{issuer:t,label:n,secret:r,counter:o=0,algorithm:s="sha1",digits:a=6}=e,c=t?`${t}:${n}`:n;return _t({type:"hotp",label:c,params:{secret:r,issuer:t,algorithm:s,digits:a,counter:o}})}function Bt(e){let{secret:t,counter:n,algorithm:r="sha1",digits:o=6,crypto:s,base32:a,guardrails:c,hooks:l}=e;De(t),ie(s);let d=Me(t,a);$e(d,c),Ct(n,c);let u=tr(s),f=Yn(n);return{ctx:u,algorithm:r,digits:o,secretBytes:d,counterBytes:f,hooks:l}}async function Ze(e){let{ctx:t,algorithm:n,digits:r,secretBytes:o,counterBytes:s,hooks:a}=Bt(e),c=await t.hmac(n,o,s),l=a?.truncateDigest?a.truncateDigest(c):$t(c);return a?.encodeToken?a.encodeToken(l,r):Mt(l,r)}function et(e){let{ctx:t,algorithm:n,digits:r,secretBytes:o,counterBytes:s,hooks:a}=Bt(e),c=t.hmacSync(n,o,s),l=a?.truncateDigest?a.truncateDigest(c):$t(c);return a?.encodeToken?a.encodeToken(l,r):Mt(l,r)}function Ot(e){let{secret:t,counter:n,token:r,algorithm:o="sha1",digits:s=6,crypto:a,base32:c,counterTolerance:l=0,guardrails:d=ae(),hooks:u}=e;De(t),ie(a);let f=Me(t,c);$e(f,d),Ct(n,d),u?.validateToken?u.validateToken(r,s):Pt(r,s),zn(l,d);let h=typeof n=="bigint"?Number(n):n,[p,g]=Dt(l),v=p+g+1;return{token:r,counterNum:h,past:p,future:g,totalChecks:v,crypto:a,getGenerateOptions:x=>({secret:f,counter:x,algorithm:o,digits:s,crypto:a,guardrails:d,hooks:u})}}async function or(e){let{token:t,counterNum:n,past:r,totalChecks:o,crypto:s,getGenerateOptions:a}=Ot(e),c=Math.max(0,r-n);for(let l=c;l<o;l++){let d=l-r,u=n+d,f=await Ze(a(u));if(s.constantTimeEqual(f,t))return{valid:!0,delta:d|0}}return{valid:!1}}function sr(e){let{token:t,counterNum:n,past:r,totalChecks:o,crypto:s,getGenerateOptions:a}=Ot(e),c=Math.max(0,r-n);for(let l=c;l<o;l++){let d=l-r,u=n+d,f=et(a(u));if(s.constantTimeEqual(f,t))return{valid:!0,delta:d|0}}return{valid:!1}}function Ht(e){let{secret:t,epoch:n=Math.floor(Date.now()/1e3),t0:r=0,period:o=30,algorithm:s="sha1",digits:a=6,crypto:c,base32:l,guardrails:d=ae(),hooks:u}=e;De(t),ie(c);let f=Me(t,l);$e(f,d),Tt(n),It(o,d);let h=Math.floor((n-r)/o);return{secret:f,counter:h,algorithm:s,digits:a,crypto:c,guardrails:d,hooks:u}}async function Rt(e){let t=Ht(e);return Ze(t)}function Ut(e){let t=Ht(e);return et(t)}function ar(e,t){if(e!==void 0){if(e<0)throw new _n;if(!Number.isSafeInteger(e))throw new Bn;if(e>t)throw new On}}function Ft(e,t){return t!==void 0&&e<=t}function jt(e){let{secret:t,token:n,epoch:r=Math.floor(Date.now()/1e3),t0:o=0,period:s=30,algorithm:a="sha1",digits:c=6,crypto:l,base32:d,epochTolerance:u=0,afterTimeStep:f,guardrails:h=ae(),hooks:p}=e;De(t),ie(l);let g=Me(t,d);$e(g,h),Tt(r),It(s,h),p?.validateToken?p.validateToken(n,c):Pt(n,c),Kn(u,s,h);let v=Math.floor((r-o)/s),[x,G]=Zn(u),W=Math.max(0,Math.floor((r-x-o)/s)),w=Math.floor((r+G-o)/s);return ar(f,w),{token:n,crypto:l,minCounter:W,maxCounter:w,currentCounter:v,t0:o,period:s,afterTimeStep:f,getGenerateOptions:I=>({secret:g,epoch:I*s+o,t0:o,period:s,algorithm:a,digits:c,crypto:l,guardrails:h,hooks:p})}}async function ir(e){let{token:t,crypto:n,minCounter:r,maxCounter:o,currentCounter:s,t0:a,period:c,afterTimeStep:l,getGenerateOptions:d}=jt(e);for(let u=r;u<=o;u++){if(Ft(u,l))continue;let f=await Rt(d(u));if(n.constantTimeEqual(f,t))return{valid:!0,delta:u-s,epoch:u*c+a,timeStep:u}}return{valid:!1}}function cr(e){let{token:t,crypto:n,minCounter:r,maxCounter:o,currentCounter:s,t0:a,period:c,afterTimeStep:l,getGenerateOptions:d}=jt(e);for(let u=r;u<=o;u++){if(Ft(u,l))continue;let f=Ut(d(u));if(n.constantTimeEqual(f,t))return{valid:!0,delta:u-s,epoch:u*c+a,timeStep:u}}return{valid:!1}}function lr(e){return e instanceof Uint8Array||ArrayBuffer.isView(e)&&e.constructor.name==="Uint8Array"}function Gt(e,t){return Array.isArray(t)?t.length===0?!0:e?t.every(n=>typeof n=="string"):t.every(n=>Number.isSafeInteger(n)):!1}function ve(e,t){if(typeof t!="string")throw new Error(`${e}: string expected`);return!0}function tt(e){if(!Number.isSafeInteger(e))throw new Error(`invalid integer: ${e}`)}function Ve(e){if(!Array.isArray(e))throw new Error("array expected")}function Ee(e,t){if(!Gt(!0,t))throw new Error(`${e}: array of strings expected`)}function dr(e,t){if(!Gt(!1,t))throw new Error(`${e}: array of numbers expected`)}function ur(...e){const t=s=>s,n=(s,a)=>c=>s(a(c)),r=e.map(s=>s.encode).reduceRight(n,t),o=e.map(s=>s.decode).reduce(n,t);return{encode:r,decode:o}}function fr(e){const t=typeof e=="string"?e.split(""):e,n=t.length;Ee("alphabet",t);const r=new Map(t.map((o,s)=>[o,s]));return{encode:o=>(Ve(o),o.map(s=>{if(!Number.isSafeInteger(s)||s<0||s>=n)throw new Error(`alphabet.encode: digit index outside alphabet "${s}". Allowed: ${e}`);return t[s]})),decode:o=>(Ve(o),o.map(s=>{ve("alphabet.decode",s);const a=r.get(s);if(a===void 0)throw new Error(`Unknown letter: "${s}". Allowed: ${e}`);return a}))}}function hr(e=""){return ve("join",e),{encode:t=>(Ee("join.decode",t),t.join(e)),decode:t=>(ve("join.decode",t),t.split(e))}}function pr(e,t="="){return tt(e),ve("padding",t),{encode(n){for(Ee("padding.encode",n);n.length*e%8;)n.push(t);return n},decode(n){Ee("padding.decode",n);let r=n.length;if(r*e%8)throw new Error("padding: invalid, string should have whole number of bytes");for(;r>0&&n[r-1]===t;r--)if((r-1)*e%8===0)throw new Error("padding: invalid, string has too much padding");return n.slice(0,r)}}}const Wt=(e,t)=>t===0?e:Wt(t,e%t),xe=(e,t)=>e+(t-Wt(e,t)),Ge=(()=>{let e=[];for(let t=0;t<40;t++)e.push(2**t);return e})();function ft(e,t,n,r){if(Ve(e),t<=0||t>32)throw new Error(`convertRadix2: wrong from=${t}`);if(n<=0||n>32)throw new Error(`convertRadix2: wrong to=${n}`);if(xe(t,n)>32)throw new Error(`convertRadix2: carry overflow from=${t} to=${n} carryBits=${xe(t,n)}`);let o=0,s=0;const a=Ge[t],c=Ge[n]-1,l=[];for(const d of e){if(tt(d),d>=a)throw new Error(`convertRadix2: invalid data word=${d} from=${t}`);if(o=o<<t|d,s+t>32)throw new Error(`convertRadix2: carry overflow pos=${s} from=${t}`);for(s+=t;s>=n;s-=n)l.push((o>>s-n&c)>>>0);const u=Ge[s];if(u===void 0)throw new Error("invalid carry");o&=u-1}if(o=o<<n-s&c,!r&&s>=t)throw new Error("Excess padding");if(!r&&o>0)throw new Error(`Non-zero padding: ${o}`);return r&&s>0&&l.push(o>>>0),l}function gr(e,t=!1){if(tt(e),e<=0||e>32)throw new Error("radix2: bits should be in (0..32]");if(xe(8,e)>32||xe(e,8)>32)throw new Error("radix2: carry overflow");return{encode:n=>{if(!lr(n))throw new Error("radix2.encode input should be Uint8Array");return ft(Array.from(n),8,e,!t)},decode:n=>(dr("radix2.decode",n),Uint8Array.from(ft(n,e,8,t)))}}const ht=ur(gr(5),fr("ABCDEFGHIJKLMNOPQRSTUVWXYZ234567"),pr(5),hr(""));var mr=class{name="scure";encode(e,t={}){let{padding:n=!1}=t,r=ht.encode(e);return n?r:r.replace(/=+$/,"")}decode(e){try{let t=e.toUpperCase(),n=t.padEnd(Math.ceil(t.length/8)*8,"=");return ht.decode(n)}catch(t){throw t instanceof Error?new Error(`Invalid Base32 string: ${t.message}`):new Error("Invalid Base32 string")}}},Xt=Object.freeze(new mr);function wr(e){return e instanceof Uint8Array||ArrayBuffer.isView(e)&&e.constructor.name==="Uint8Array"}function pt(e,t=""){if(!Number.isSafeInteger(e)||e<0){const n=t&&`"${t}" `;throw new Error(`${n}expected integer >= 0, got ${e}`)}}function Ae(e,t,n=""){const r=wr(e),o=e?.length,s=t!==void 0;if(!r||s&&o!==t){const a=n&&`"${n}" `,c=s?` of length ${t}`:"",l=r?`length=${o}`:`type=${typeof e}`;throw new Error(a+"expected Uint8Array"+c+", got "+l)}return e}function yr(e){if(typeof e!="function"||typeof e.create!="function")throw new Error("Hash must wrapped by utils.createHasher");pt(e.outputLen),pt(e.blockLen)}function Le(e,t=!0){if(e.destroyed)throw new Error("Hash instance has been destroyed");if(t&&e.finished)throw new Error("Hash#digest() has already been called")}function br(e,t){Ae(e,void 0,"digestInto() output");const n=t.outputLen;if(e.length<n)throw new Error('"digestInto() output" expected to be of length >='+n)}function F(...e){for(let t=0;t<e.length;t++)e[t].fill(0)}function We(e){return new DataView(e.buffer,e.byteOffset,e.byteLength)}function P(e,t){return e<<32-t|e>>>t}function Xe(e,t){return e<<t|e>>>32-t>>>0}function nt(e,t={}){const n=(o,s)=>e(s).update(o).digest(),r=e(void 0);return n.outputLen=r.outputLen,n.blockLen=r.blockLen,n.create=o=>e(o),Object.assign(n,t),Object.freeze(n)}function vr(e=32){const t=typeof globalThis=="object"?globalThis.crypto:null;if(typeof t?.getRandomValues!="function")throw new Error("crypto.getRandomValues must be defined");return t.getRandomValues(new Uint8Array(e))}const Vt=e=>({oid:Uint8Array.from([6,9,96,134,72,1,101,3,4,2,e])});class zt{oHash;iHash;blockLen;outputLen;finished=!1;destroyed=!1;constructor(t,n){if(yr(t),Ae(n,void 0,"key"),this.iHash=t.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const r=this.blockLen,o=new Uint8Array(r);o.set(n.length>r?t.create().update(n).digest():n);for(let s=0;s<o.length;s++)o[s]^=54;this.iHash.update(o),this.oHash=t.create();for(let s=0;s<o.length;s++)o[s]^=106;this.oHash.update(o),F(o)}update(t){return Le(this),this.iHash.update(t),this}digestInto(t){Le(this),Ae(t,this.outputLen,"output"),this.finished=!0,this.iHash.digestInto(t),this.oHash.update(t),this.oHash.digestInto(t),this.destroy()}digest(){const t=new Uint8Array(this.oHash.outputLen);return this.digestInto(t),t}_cloneInto(t){t||=Object.create(Object.getPrototypeOf(this),{});const{oHash:n,iHash:r,finished:o,destroyed:s,blockLen:a,outputLen:c}=this;return t=t,t.finished=o,t.destroyed=s,t.blockLen=a,t.outputLen=c,t.oHash=n._cloneInto(t.oHash),t.iHash=r._cloneInto(t.iHash),t}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const Kt=(e,t,n)=>new zt(e,t).update(n).digest();Kt.create=(e,t)=>new zt(e,t);function Yt(e,t,n){return e&t^~e&n}function qt(e,t,n){return e&t^e&n^t&n}class rt{blockLen;outputLen;padOffset;isLE;buffer;view;finished=!1;length=0;pos=0;destroyed=!1;constructor(t,n,r,o){this.blockLen=t,this.outputLen=n,this.padOffset=r,this.isLE=o,this.buffer=new Uint8Array(t),this.view=We(this.buffer)}update(t){Le(this),Ae(t);const{view:n,buffer:r,blockLen:o}=this,s=t.length;for(let a=0;a<s;){const c=Math.min(o-this.pos,s-a);if(c===o){const l=We(t);for(;o<=s-a;a+=o)this.process(l,a);continue}r.set(t.subarray(a,a+c),this.pos),this.pos+=c,a+=c,this.pos===o&&(this.process(n,0),this.pos=0)}return this.length+=t.length,this.roundClean(),this}digestInto(t){Le(this),br(t,this),this.finished=!0;const{buffer:n,view:r,blockLen:o,isLE:s}=this;let{pos:a}=this;n[a++]=128,F(this.buffer.subarray(a)),this.padOffset>o-a&&(this.process(r,0),a=0);for(let f=a;f<o;f++)n[f]=0;r.setBigUint64(o-8,BigInt(this.length*8),s),this.process(r,0);const c=We(t),l=this.outputLen;if(l%4)throw new Error("_sha2: outputLen must be aligned to 32bit");const d=l/4,u=this.get();if(d>u.length)throw new Error("_sha2: outputLen bigger than state");for(let f=0;f<d;f++)c.setUint32(4*f,u[f],s)}digest(){const{buffer:t,outputLen:n}=this;this.digestInto(t);const r=t.slice(0,n);return this.destroy(),r}_cloneInto(t){t||=new this.constructor,t.set(...this.get());const{blockLen:n,buffer:r,length:o,finished:s,destroyed:a,pos:c}=this;return t.destroyed=a,t.finished=s,t.length=o,t.pos=c,o%n&&t.buffer.set(r),t}clone(){return this._cloneInto()}}const _=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),E=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]),te=Uint32Array.from([1732584193,4023233417,2562383102,271733878,3285377520]),B=new Uint32Array(80);class Er extends rt{A=te[0]|0;B=te[1]|0;C=te[2]|0;D=te[3]|0;E=te[4]|0;constructor(){super(64,20,8,!1)}get(){const{A:t,B:n,C:r,D:o,E:s}=this;return[t,n,r,o,s]}set(t,n,r,o,s){this.A=t|0,this.B=n|0,this.C=r|0,this.D=o|0,this.E=s|0}process(t,n){for(let l=0;l<16;l++,n+=4)B[l]=t.getUint32(n,!1);for(let l=16;l<80;l++)B[l]=Xe(B[l-3]^B[l-8]^B[l-14]^B[l-16],1);let{A:r,B:o,C:s,D:a,E:c}=this;for(let l=0;l<80;l++){let d,u;l<20?(d=Yt(o,s,a),u=1518500249):l<40?(d=o^s^a,u=1859775393):l<60?(d=qt(o,s,a),u=2400959708):(d=o^s^a,u=3395469782);const f=Xe(r,5)+d+c+u+B[l]|0;c=a,a=s,s=Xe(o,30),o=r,r=f}r=r+this.A|0,o=o+this.B|0,s=s+this.C|0,a=a+this.D|0,c=c+this.E|0,this.set(r,o,s,a,c)}roundClean(){F(B)}destroy(){this.set(0,0,0,0,0),F(this.buffer)}}const xr=nt(()=>new Er),he=BigInt(2**32-1),gt=BigInt(32);function Ar(e,t=!1){return t?{h:Number(e&he),l:Number(e>>gt&he)}:{h:Number(e>>gt&he)|0,l:Number(e&he)|0}}function Lr(e,t=!1){const n=e.length;let r=new Uint32Array(n),o=new Uint32Array(n);for(let s=0;s<n;s++){const{h:a,l:c}=Ar(e[s],t);[r[s],o[s]]=[a,c]}return[r,o]}const mt=(e,t,n)=>e>>>n,wt=(e,t,n)=>e<<32-n|t>>>n,q=(e,t,n)=>e>>>n|t<<32-n,J=(e,t,n)=>e<<32-n|t>>>n,pe=(e,t,n)=>e<<64-n|t>>>n-32,ge=(e,t,n)=>e>>>n-32|t<<64-n;function D(e,t,n,r){const o=(t>>>0)+(r>>>0);return{h:e+n+(o/2**32|0)|0,l:o|0}}const kr=(e,t,n)=>(e>>>0)+(t>>>0)+(n>>>0),Sr=(e,t,n,r)=>t+n+r+(e/2**32|0)|0,Cr=(e,t,n,r)=>(e>>>0)+(t>>>0)+(n>>>0)+(r>>>0),Tr=(e,t,n,r,o)=>t+n+r+o+(e/2**32|0)|0,Ir=(e,t,n,r,o)=>(e>>>0)+(t>>>0)+(n>>>0)+(r>>>0)+(o>>>0),Pr=(e,t,n,r,o,s)=>t+n+r+o+s+(e/2**32|0)|0,$r=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),O=new Uint32Array(64);class Mr extends rt{constructor(t){super(64,t,8,!1)}get(){const{A:t,B:n,C:r,D:o,E:s,F:a,G:c,H:l}=this;return[t,n,r,o,s,a,c,l]}set(t,n,r,o,s,a,c,l){this.A=t|0,this.B=n|0,this.C=r|0,this.D=o|0,this.E=s|0,this.F=a|0,this.G=c|0,this.H=l|0}process(t,n){for(let f=0;f<16;f++,n+=4)O[f]=t.getUint32(n,!1);for(let f=16;f<64;f++){const h=O[f-15],p=O[f-2],g=P(h,7)^P(h,18)^h>>>3,v=P(p,17)^P(p,19)^p>>>10;O[f]=v+O[f-7]+g+O[f-16]|0}let{A:r,B:o,C:s,D:a,E:c,F:l,G:d,H:u}=this;for(let f=0;f<64;f++){const h=P(c,6)^P(c,11)^P(c,25),p=u+h+Yt(c,l,d)+$r[f]+O[f]|0,v=(P(r,2)^P(r,13)^P(r,22))+qt(r,o,s)|0;u=d,d=l,l=c,c=a+p|0,a=s,s=o,o=r,r=p+v|0}r=r+this.A|0,o=o+this.B|0,s=s+this.C|0,a=a+this.D|0,c=c+this.E|0,l=l+this.F|0,d=d+this.G|0,u=u+this.H|0,this.set(r,o,s,a,c,l,d,u)}roundClean(){F(O)}destroy(){this.set(0,0,0,0,0,0,0,0),F(this.buffer)}}class Dr extends Mr{A=_[0]|0;B=_[1]|0;C=_[2]|0;D=_[3]|0;E=_[4]|0;F=_[5]|0;G=_[6]|0;H=_[7]|0;constructor(){super(32)}}const Jt=Lr(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(e=>BigInt(e))),Nr=Jt[0],_r=Jt[1],H=new Uint32Array(80),R=new Uint32Array(80);class Br extends rt{constructor(t){super(128,t,16,!1)}get(){const{Ah:t,Al:n,Bh:r,Bl:o,Ch:s,Cl:a,Dh:c,Dl:l,Eh:d,El:u,Fh:f,Fl:h,Gh:p,Gl:g,Hh:v,Hl:x}=this;return[t,n,r,o,s,a,c,l,d,u,f,h,p,g,v,x]}set(t,n,r,o,s,a,c,l,d,u,f,h,p,g,v,x){this.Ah=t|0,this.Al=n|0,this.Bh=r|0,this.Bl=o|0,this.Ch=s|0,this.Cl=a|0,this.Dh=c|0,this.Dl=l|0,this.Eh=d|0,this.El=u|0,this.Fh=f|0,this.Fl=h|0,this.Gh=p|0,this.Gl=g|0,this.Hh=v|0,this.Hl=x|0}process(t,n){for(let w=0;w<16;w++,n+=4)H[w]=t.getUint32(n),R[w]=t.getUint32(n+=4);for(let w=16;w<80;w++){const I=H[w-15]|0,N=R[w-15]|0,Re=q(I,N,1)^q(I,N,8)^mt(I,N,7),Ue=J(I,N,1)^J(I,N,8)^wt(I,N,7),$=H[w-2]|0,M=R[w-2]|0,de=q($,M,19)^pe($,M,61)^mt($,M,6),Fe=J($,M,19)^ge($,M,61)^wt($,M,6),ue=Cr(Ue,Fe,R[w-7],R[w-16]),je=Tr(ue,Re,de,H[w-7],H[w-16]);H[w]=je|0,R[w]=ue|0}let{Ah:r,Al:o,Bh:s,Bl:a,Ch:c,Cl:l,Dh:d,Dl:u,Eh:f,El:h,Fh:p,Fl:g,Gh:v,Gl:x,Hh:G,Hl:W}=this;for(let w=0;w<80;w++){const I=q(f,h,14)^q(f,h,18)^pe(f,h,41),N=J(f,h,14)^J(f,h,18)^ge(f,h,41),Re=f&p^~f&v,Ue=h&g^~h&x,$=Ir(W,N,Ue,_r[w],R[w]),M=Pr($,G,I,Re,Nr[w],H[w]),de=$|0,Fe=q(r,o,28)^pe(r,o,34)^pe(r,o,39),ue=J(r,o,28)^ge(r,o,34)^ge(r,o,39),je=r&s^r&c^s&c,mn=o&a^o&l^a&l;G=v|0,W=x|0,v=p|0,x=g|0,p=f|0,g=h|0,{h:f,l:h}=D(d|0,u|0,M|0,de|0),d=c|0,u=l|0,c=s|0,l=a|0,s=r|0,a=o|0;const lt=kr(de,ue,mn);r=Sr(lt,M,Fe,je),o=lt|0}({h:r,l:o}=D(this.Ah|0,this.Al|0,r|0,o|0)),{h:s,l:a}=D(this.Bh|0,this.Bl|0,s|0,a|0),{h:c,l}=D(this.Ch|0,this.Cl|0,c|0,l|0),{h:d,l:u}=D(this.Dh|0,this.Dl|0,d|0,u|0),{h:f,l:h}=D(this.Eh|0,this.El|0,f|0,h|0),{h:p,l:g}=D(this.Fh|0,this.Fl|0,p|0,g|0),{h:v,l:x}=D(this.Gh|0,this.Gl|0,v|0,x|0),{h:G,l:W}=D(this.Hh|0,this.Hl|0,G|0,W|0),this.set(r,o,s,a,c,l,d,u,f,h,p,g,v,x,G,W)}roundClean(){F(H,R)}destroy(){F(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}}class Or extends Br{Ah=E[0]|0;Al=E[1]|0;Bh=E[2]|0;Bl=E[3]|0;Ch=E[4]|0;Cl=E[5]|0;Dh=E[6]|0;Dl=E[7]|0;Eh=E[8]|0;El=E[9]|0;Fh=E[10]|0;Fl=E[11]|0;Gh=E[12]|0;Gl=E[13]|0;Hh=E[14]|0;Hl=E[15]|0;constructor(){super(64)}}const Hr=nt(()=>new Dr,Vt(1)),Rr=nt(()=>new Or,Vt(3));var Ur=class{name="noble";hmac(e,t,n){return Kt(e==="sha1"?xr:e==="sha256"?Hr:Rr,t,n)}randomBytes(e){return vr(e)}constantTimeEqual(e,t){return Jn(e,t)}},Qt=Object.freeze(new Ur);function ot(e){return{secret:e.secret,strategy:e.strategy??"totp",crypto:e.crypto??Qt,base32:e.base32??Xt,algorithm:e.algorithm??"sha1",digits:e.digits??6,period:e.period??30,epoch:e.epoch??Math.floor(Date.now()/1e3),t0:e.t0??0,counter:e.counter,guardrails:e.guardrails??ae(),hooks:e.hooks}}function Zt(e){return{...ot(e),token:e.token,epochTolerance:e.epochTolerance??0,counterTolerance:e.counterTolerance??0,afterTimeStep:e.afterTimeStep}}function ce(e,t,n){if(e==="totp")return n.totp();if(e==="hotp"){if(t===void 0)throw new V("Counter is required for HOTP strategy. Example: { strategy: 'hotp', counter: 0 }");return n.hotp(t)}throw new V(`Unknown OTP strategy: ${e}. Valid strategies are 'totp' or 'hotp'.`)}function Fr(e){let{strategy:t="totp",issuer:n,label:r,secret:o,algorithm:s="sha1",digits:a=6,period:c=30,counter:l}=e;return ce(t,l,{totp:()=>nr({issuer:n,label:r,secret:o,algorithm:s,digits:a,period:c}),hotp:d=>rr({issuer:n,label:r,secret:o,algorithm:s,digits:a,counter:d})})}async function en(e){let t=ot(e),{secret:n,crypto:r,base32:o,algorithm:s,digits:a,hooks:c}=t,l={secret:n,crypto:r,base32:o,algorithm:s,digits:a,hooks:c};return ce(t.strategy,t.counter,{totp:()=>Rt({...l,period:t.period,epoch:t.epoch,t0:t.t0,guardrails:t.guardrails}),hotp:d=>Ze({...l,counter:d,guardrails:t.guardrails})})}function jr(e){let t=ot(e),{secret:n,crypto:r,base32:o,algorithm:s,digits:a}=t,c={secret:n,crypto:r,base32:o,algorithm:s,digits:a};return ce(t.strategy,t.counter,{totp:()=>Ut({...c,period:t.period,epoch:t.epoch,t0:t.t0,guardrails:t.guardrails}),hotp:l=>et({...c,counter:l,guardrails:t.guardrails})})}async function Gr(e){let t=Zt(e),{secret:n,token:r,crypto:o,base32:s,algorithm:a,digits:c,hooks:l}=t,d={secret:n,token:r,crypto:o,base32:s,algorithm:a,digits:c,hooks:l};return ce(t.strategy,t.counter,{totp:()=>ir({...d,period:t.period,epoch:t.epoch,t0:t.t0,epochTolerance:t.epochTolerance,afterTimeStep:t.afterTimeStep,guardrails:t.guardrails}),hotp:u=>or({...d,counter:u,counterTolerance:t.counterTolerance,guardrails:t.guardrails})})}function Wr(e){let t=Zt(e),{secret:n,token:r,crypto:o,base32:s,algorithm:a,digits:c,hooks:l}=t,d={secret:n,token:r,crypto:o,base32:s,algorithm:a,digits:c,hooks:l};return ce(t.strategy,t.counter,{totp:()=>cr({...d,period:t.period,epoch:t.epoch,t0:t.t0,epochTolerance:t.epochTolerance,afterTimeStep:t.afterTimeStep,guardrails:t.guardrails}),hotp:u=>sr({...d,counter:u,counterTolerance:t.counterTolerance,guardrails:t.guardrails})})}var Xr=class{strategy;crypto;base32;guardrails;constructor(e={}){let{strategy:t="totp",crypto:n=Qt,base32:r=Xt,guardrails:o}=e;this.strategy=t,this.crypto=n,this.base32=r,this.guardrails=ae(o)}getStrategy(){return this.strategy}generateSecret(e=20){return Qn({crypto:this.crypto,base32:this.base32,length:e})}async generate(e){return en({...e,strategy:this.strategy,crypto:this.crypto,base32:this.base32,guardrails:e.guardrails??this.guardrails})}generateSync(e){return jr({...e,strategy:this.strategy,crypto:this.crypto,base32:this.base32,guardrails:e.guardrails??this.guardrails})}async verify(e){return Gr({...e,strategy:this.strategy,crypto:this.crypto,base32:this.base32,guardrails:e.guardrails??this.guardrails})}verifySync(e){return Wr({...e,strategy:this.strategy,crypto:this.crypto,base32:this.base32,guardrails:e.guardrails??this.guardrails})}generateURI(e){return Fr({...e,strategy:this.strategy})}};new Xr;async function Vr(e,t={}){const{digits:n=6,period:r=30,algorithm:o="SHA1"}=t,s=e.replace(/\s/g,"").toUpperCase();if(!ke(s))throw new Error("Invalid Base32 secret key");try{return await en({secret:s,digits:n,period:r,algorithm:o.toUpperCase(),window:1})}catch(a){throw console.error("[TOTP] Generation error:",a),new Error("Failed to generate TOTP code: "+a.message)}}function zr(e=30){return e-Math.floor(Date.now()/1e3)%e}function Kr(e){return e?e.length===6?`${e.slice(0,3)} ${e.slice(3)}`:e.length===8?`${e.slice(0,4)} ${e.slice(4)}`:e:"--- ---"}function ke(e){if(!e||typeof e!="string")return!1;const t=e.toUpperCase().replace(/\s/g,"").replace(/=+$/,"");return/^[A-Z2-7]+$/.test(t)&&t.length>=8}const st=new TextEncoder,Yr=new TextDecoder;let me=null;function ze(e){return crypto.getRandomValues(new Uint8Array(e))}function re(e){return btoa(String.fromCharCode(...e))}function ye(e){return Uint8Array.from(atob(e),t=>t.charCodeAt(0))}async function tn(e,t){const n=await crypto.subtle.importKey("raw",st.encode(e),"PBKDF2",!1,["deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:31e4,hash:"SHA-256"},n,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}async function nn(){if(me)return me;const e=chrome.runtime.id||"azkura-auth",t=navigator.userAgent||"unknown",n=`${screen.width}x${screen.height}`,r=`${e}:${t}:${n}:azkura-default-key-v1`,s=new TextEncoder().encode(r),a=await crypto.subtle.digest("SHA-256",s),c=Array.from(new Uint8Array(a));return me=btoa(String.fromCharCode(...c)),me}async function Ne(e,t){const n=t||await nn(),r=ze(16),o=ze(12),s=await tn(n,r),a=await crypto.subtle.encrypt({name:"AES-GCM",iv:o},s,st.encode(e));return{salt:re(r),iv:re(o),ciphertext:re(new Uint8Array(a)),version:1}}async function rn(e,t){const n=t||await nn(),r=ye(e.salt),o=ye(e.iv),s=ye(e.ciphertext),a=await tn(n,r);try{const c=await crypto.subtle.decrypt({name:"AES-GCM",iv:o},a,s);return Yr.decode(c)}catch{throw new Error("Incorrect PIN/password or corrupted data")}}async function on(e,t){const n=await crypto.subtle.importKey("raw",st.encode(e),"PBKDF2",!1,["deriveBits"]),r=await crypto.subtle.deriveBits({name:"PBKDF2",salt:t,iterations:1e5,hash:"SHA-256"},n,256);return re(new Uint8Array(r))}async function sn(e,t,n){const r=ye(n);return await on(e,r)===t}async function at(e){const t=ze(16);return{hash:await on(e,t),salt:re(t)}}function an(e){if(!e||typeof e!="string")throw new Error("Invalid URI: must be a string");const t=e.trim();if(!t.startsWith("otpauth://"))throw new Error("Invalid URI: must start with otpauth://");let n;try{n=new URL(t)}catch{throw new Error("Invalid URI: malformed URL")}const r=n.hostname.toLowerCase();if(r!=="totp"&&r!=="hotp")throw new Error(`Unsupported OTP type: ${r}`);const o=decodeURIComponent(n.pathname.slice(1));let s="",a=o;if(o.includes(":")){const h=o.indexOf(":");s=o.slice(0,h).trim(),a=o.slice(h+1).trim()}const c=n.searchParams;c.get("issuer")&&(s=c.get("issuer"));const l=c.get("secret");if(!l)throw new Error("Invalid URI: missing secret parameter");const d=(c.get("algorithm")||"SHA1").toUpperCase(),u=parseInt(c.get("digits")||"6",10),f=parseInt(c.get("period")||"30",10);return{type:r,issuer:s||a.split("@")[1]||"Unknown",account:a,secret:l.replace(/\s/g,"").toUpperCase(),algorithm:d,digits:isNaN(u)?6:u,period:isNaN(f)?30:f}}async function S(e){return new Promise(t=>{chrome.storage.local.get(e,n=>t(n[e]))})}async function j(e,t){return new Promise(n=>{chrome.storage.local.set({[e]:t},n)})}async function yt(e){return new Promise(t=>{chrome.storage.local.remove(e,t)})}async function qr(){return new Promise(e=>{chrome.storage.local.clear(e)})}async function cn(e){return new Promise(t=>{chrome.storage.session.get(e,n=>t(n[e]))})}async function Jr(e,t){return new Promise(n=>{chrome.storage.session.set({[e]:t},n)})}async function ln(){return new Promise(e=>{chrome.storage.session.clear(e)})}async function Qr(e){return new Promise(t=>{chrome.storage.sync.get(e,n=>t(n[e]))})}async function dn(e,t){return new Promise(n=>{chrome.storage.sync.set({[e]:t},n)})}async function it(){return!!await S("pinData")}async function Zr(){const e=await Qr("pinEnabled");return e===void 0?await it():e}async function Se(e){return dn("pinEnabled",e)}async function eo(){const e=await cn("accounts");return Array.isArray(e)}async function to(){const e=await S("pinData"),t=await S("vault");return!e&&!t}async function _e(){return cn("accounts")}async function ee(e){return Jr("accounts",e)}async function no(){const e={accentColor:"#00E5FF",autoLockMinutes:5,privacyMode:!1,compactLayout:!1,closeAfterCopy:!0,autoFocusSearch:!0,pinEnabled:!0},t=await new Promise(n=>{chrome.storage.sync.get(Object.keys(e),r=>n(r))});return{...e,...t}}async function Q(e,t){return dn(e,t)}const ro="https://www.googleapis.com/oauth2/v2/userinfo",se="googleAuthToken",Be="googleUserProfile";async function un(){const e=await S(se),t=await S(Be);return!!(e&&t)}async function oo(){return await S(Be)}async function so(){return await S(se)}async function ao(){try{const e=await new Promise((n,r)=>{chrome.identity.getAuthToken({interactive:!0},o=>{chrome.runtime.lastError?r(new Error(chrome.runtime.lastError.message)):o?n(o):r(new Error("No token received"))})});await j(se,e);const t=await co(e);if(!t)throw new Error("Failed to fetch user profile");return await j(Be,t),{success:!0,user:t}}catch(e){return console.error("[Google Auth] Login failed:",e),{success:!1,error:e.message}}}async function io(){try{const e=await S(se);return e&&await new Promise(t=>{chrome.identity.removeCachedAuthToken({token:e},t)}),await yt(se),await yt(Be),{success:!0}}catch(e){return console.error("[Google Auth] Logout failed:",e),{success:!1,error:e.message}}}async function co(e){try{const t=await fetch(ro,{headers:{Authorization:`Bearer ${e}`,Accept:"application/json"}});if(!t.ok)throw new Error(`HTTP ${t.status}`);const n=await t.json();return{name:n.name||"Google User",email:n.email||"",picture:n.picture||null,id:n.id||""}}catch(t){return console.error("[Google Auth] Fetch profile failed:",t),null}}const lo="https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart";async function uo(e,t=null){try{const n=await so();if(!n)return{success:!1,error:"Not authenticated with Google"};const r=new Date().toISOString().slice(0,19).replace(/[:T]/g,"-"),o=t||`azkura-backup-${r}.json`,s={app:"azkura-auth",version:chrome.runtime.getManifest().version,exportedAt:new Date().toISOString(),accountCount:e.length,accounts:e},a=JSON.stringify(s,null,2),c="-------314159265358979323846",l=`\r
--${c}\r
`,d=`\r
--${c}--`,u={name:o,mimeType:"application/json",description:"Azkura Auth Backup - TOTP Authenticator Data"},f=l+`Content-Type: application/json; charset=UTF-8\r
\r
`+JSON.stringify(u)+l+`Content-Type: application/json\r
\r
`+a+d,h=await fetch(lo,{method:"POST",headers:{Authorization:`Bearer ${n}`,"Content-Type":`multipart/related; boundary="${c}"`},body:f});if(!h.ok){const g=await h.json().catch(()=>({}));throw new Error(g.error?.message||`HTTP ${h.status}`)}return{success:!0,fileId:(await h.json()).id,fileName:o}}catch(n){return console.error("[Google Drive] Upload failed:",n),{success:!1,error:n.message||"Failed to upload backup"}}}function fn(){return`${Date.now()}-${Math.random().toString(36).slice(2,9)}`}function fo(e){const t=(e||"").toLowerCase(),n={discord:{bg:"#5865F2",emoji:"üéÆ"},github:{bg:"#24292e",emoji:"üêô"},google:{bg:"#4285F4",emoji:"üîµ"},gmail:{bg:"#EA4335",emoji:"üìß"},aws:{bg:"#FF9900",emoji:"‚òÅÔ∏è"},amazon:{bg:"#FF9900",emoji:"üì¶"},stripe:{bg:"#6772E5",emoji:"üí≥"},twitter:{bg:"#1DA1F2",emoji:"üê¶"},x:{bg:"#000000",emoji:"‚úñÔ∏è"},facebook:{bg:"#1877F2",emoji:"üìò"},instagram:{bg:"#E1306C",emoji:"üì∑"},microsoft:{bg:"#00A4EF",emoji:"ü™ü"},apple:{bg:"#555555",emoji:"üçé"},gitlab:{bg:"#FC6D26",emoji:"ü¶ä"},dropbox:{bg:"#0061FF",emoji:"üì¶"},slack:{bg:"#4A154B",emoji:"üí¨"},twitch:{bg:"#9146FF",emoji:"üéÆ"},reddit:{bg:"#FF4500",emoji:"ü§ñ"},linkedin:{bg:"#0A66C2",emoji:"üíº"},cloudflare:{bg:"#F48120",emoji:"‚òÅÔ∏è"},digitalocean:{bg:"#0080FF",emoji:"üåä"},bitwarden:{bg:"#175DDC",emoji:"üîê"},binance:{bg:"#F0B90B",emoji:"‚Çø"},coinbase:{bg:"#0052FF",emoji:"ü™ô"}};for(const[s,a]of Object.entries(n))if(t.includes(s))return a;let r=0;for(const s of e||"A")r=r*31+s.charCodeAt(0)&4294967295;return{bg:`hsl(${Math.abs(r)%360}, 60%, 40%)`,emoji:null}}async function Ce(e){const t=await S("vault");if(!t)return await ee([]),[];const n=await rn(t,e),r=JSON.parse(n);return await ee(r),r}async function Oe(e){const t=await _e();if(!t)return;const n=JSON.stringify(t),r=await Ne(n,e);await j("vault",r)}async function ho(){await ln()}async function T(){return await _e()||[]}async function po(e,t){const n=await T(),r={id:fn(),issuer:e.issuer||"",account:e.account||"",secret:e.secret.replace(/\s/g,"").toUpperCase(),algorithm:e.algorithm||"SHA1",digits:e.digits||6,period:e.period||30,createdAt:Date.now()};return n.push(r),await ee(n),await Oe(t),r}async function go(e,t,n){const r=await T(),o=r.findIndex(s=>s.id===e);if(o===-1)throw new Error("Account not found");return r[o]={...r[o],...t,id:e,updatedAt:Date.now()},t.secret&&(r[o].secret=t.secret.replace(/\s/g,"").toUpperCase()),await ee(r),await Oe(n),r[o]}async function mo(e,t){const r=(await T()).filter(o=>o.id!==e);await ee(r),await Oe(t)}async function wo(e){const t=await T();if(!e||!e.trim())return t;const n=e.toLowerCase();return t.filter(r=>(r.issuer||"").toLowerCase().includes(n)||(r.account||"").toLowerCase().includes(n))}async function yo(e){const t=await T(),n=JSON.stringify(t),r=await Ne(n,e),o={app:"azkura-auth",version:"1.0.0",exportedAt:new Date().toISOString(),accountCount:t.length,encrypted:r};return JSON.stringify(o,null,2)}async function bo(e,t,n){let r;try{r=JSON.parse(e)}catch{throw new Error("Invalid backup file: not valid JSON")}if(r.app!=="azkura-auth")throw new Error("Invalid backup file: not an Azkura Auth backup");const o=await rn(r.encrypted,t),s=JSON.parse(o);if(!Array.isArray(s))throw new Error("Invalid backup: corrupted account data");const a=await T(),c=new Set(a.map(u=>u.secret+u.account)),l=s.filter(u=>!c.has(u.secret+u.account)),d=[...a,...l.map(u=>({...u,id:fn()}))];return await ee(d),await Oe(n),{imported:l.length,total:d.length}}async function vo(){await qr(),await ln()}let k=null,oe=null,A=[],m={},Z=null,we=null;const i=e=>document.querySelector(e),He=e=>document.querySelectorAll(e);function U(e){He(".view").forEach(t=>t.classList.remove("active")),i(e).classList.add("active")}function L(e){i(e).classList.add("open")}function b(e){i(e).classList.remove("open")}function y(e,t="info",n=2500){const r=i("#toastContainer"),o={success:"‚úì",error:"‚úï",info:"‚Ñπ"},s=document.createElement("div");s.className=`toast ${t}`,s.innerHTML=`<span class="toast-icon">${o[t]||"‚Ñπ"}</span><span class="toast-text">${e}</span>`,r.appendChild(s),setTimeout(()=>{s.classList.add("out"),setTimeout(()=>s.remove(),400)},n)}function Ke(e,t,n,r){const o=i(`#${e}`),s=i(`#${t}`),a=r?i(`#${r}`):null;let c="";const l=6,d=["1","2","3","4","5","6","7","8","9","","0","‚å´"],u={2:"ABC",3:"DEF",4:"GHI",5:"JKL",6:"MNO",7:"PQRS",8:"TUV",9:"WXYZ",0:"+"};o.innerHTML="",d.forEach(p=>{const g=document.createElement("button");if(g.className="pin-key",!p){g.style.visibility="hidden",o.appendChild(g);return}g.innerHTML=`<span>${p}</span>${u[p]?`<span class="pin-key-sub">${u[p]}</span>`:""}`,g.addEventListener("click",()=>{p==="‚å´"?c=c.slice(0,-1):c.length<l&&(c+=p),f(),c.length===l&&setTimeout(()=>{n(c),c="",f()},80)}),o.appendChild(g)});function f(){s.querySelectorAll(".pin-dot").forEach((g,v)=>{g.classList.toggle("filled",v<c.length),g.classList.remove("error")}),a&&a.classList.remove("visible")}function h(p){c="",f();const g=s.querySelectorAll(".pin-dot");g.forEach(v=>v.classList.add("error")),a&&p&&(a.textContent=p,a.classList.add("visible")),setTimeout(()=>g.forEach(v=>v.classList.remove("error")),600)}return{flashError:h}}function hn(){const e=i("#onboardStep1"),t=i("#onboardStep2"),n=i("#onboardStep3");function r(s){["#step1dot","#step2dot","#step3dot"].forEach((a,c)=>{const l=i(a);l.classList.remove("active","done"),c+1===s&&l.classList.add("active"),c+1<s&&l.classList.add("done")})}i("#btnOnboardStart").addEventListener("click",()=>{e.style.display="none",t.style.display="flex",r(2)}),i("#btnBackToWelcome").addEventListener("click",()=>{t.style.display="none",e.style.display="flex",r(1),we=null}),i("#btnSkipPin").addEventListener("click",async()=>{await Se(!1),k=null,await Ce(null),U("#viewMain"),await Ie(),y("PIN skipped. You can enable it later in Settings.","info",3e3)}),Ke("pinKeypadCreate","pinDotsCreate",s=>{we=s,t.style.display="none",n.style.display="flex",r(3)},"pinCreateError");const{flashError:o}=Ke("pinKeypadConfirm","pinDotsConfirm",async s=>{if(s!==we){o("PINs do not match. Try again."),we=null,setTimeout(()=>{n.style.display="none",t.style.display="flex",r(2)},700);return}const a=await at(s);await j("pinData",a),await Se(!0),k=s,await Ce(s).catch(()=>{}),r(3),U("#viewMain"),await Ie()},"pinConfirmError")}function Eo(){const{flashError:e}=Ke("pinKeypadLock","pinDotsLock",async t=>{try{const n=await S("pinData");if(!await sn(t,n.hash,n.salt)){e("Incorrect PIN. Try again.");return}k=t,await Ce(t),U("#viewMain"),await Ie(),ct()}catch{e("Unlock failed. Try again.")}},"pinLockError")}function ct(){const e=m.autoLockMinutes;!e||e===0||chrome.alarms.create("auto-lock",{delayInMinutes:e})}function le(){m.autoLockMinutes&&m.autoLockMinutes>0&&chrome.alarms.create("auto-lock",{delayInMinutes:m.autoLockMinutes})}function X(){document.documentElement.style.setProperty("--accent",m.accentColor||"#00E5FF");const e=m.accentColor||"#00E5FF";document.documentElement.style.setProperty("--accent-dim",`${e}26`),document.documentElement.style.setProperty("--accent-dim2",`${e}14`),document.documentElement.style.setProperty("--border-accent",`${e}4D`),document.getElementById("app").classList.toggle("privacy-mode",!!m.privacyMode),document.getElementById("app").classList.toggle("layout-compact",!!m.compactLayout);const t=i("#privacyModeToggle"),n=i("#compactLayoutToggle"),r=i("#closeAfterCopyToggle"),o=i("#autoFocusSearchToggle"),s=i("#autoLockSelect"),a=i("#pinProtectionToggle");t&&(t.checked=!!m.privacyMode),n&&(n.checked=!!m.compactLayout),r&&(r.checked=m.closeAfterCopy!==!1),o&&(o.checked=m.autoFocusSearch!==!1),s&&(s.value=String(m.autoLockMinutes??5)),a&&(a.checked=!!m.pinEnabled),He("#accentColorPicker .color-swatch").forEach(c=>{c.classList.toggle("active",c.dataset.color===e)}),xo()}function xo(){const e=m.pinEnabled,t=i("#btnChangePIN"),n=i("#autoLockItem"),r=i("#pinDisabledWarning");t&&(t.style.display=e?"flex":"none"),n&&(n.style.display=e?"flex":"none"),r&&(r.style.display=e?"none":"flex")}function Ao(e){const o=2*Math.PI*14.5,s=document.createElement("div");return s.className="progress-ring",s.innerHTML=`
    <svg width="32" height="32" viewBox="0 0 32 32">
      <circle class="progress-ring-track" cx="${32/2}" cy="${32/2}" r="${14.5}" stroke-width="3"/>
      <circle class="progress-ring-fill" cx="${32/2}" cy="${32/2}" r="${14.5}" stroke-width="3"
        stroke-dasharray="${o}" stroke-dashoffset="${o}" stroke="var(--totp-normal)"/>
    </svg>
    <div class="progress-ring-text">30</div>
  `,s._circumference=o,s._period=e,s}function Lo(e,t,n){const r=e.querySelector(".progress-ring-fill"),o=e.querySelector(".progress-ring-text"),s=e._circumference,a=t/n,c=s*(1-a);r.style.strokeDashoffset=c;let l,d;t>10?(l="var(--totp-normal)",d=""):t>5?(l="var(--totp-warning)",d="warning"):(l="var(--totp-danger)",d="danger"),r.style.stroke=l,o.textContent=t,o.className=`progress-ring-text ${d}`}function ko(e){const t=fo(e.issuer),n=document.createElement("div");n.className="account-card",n.dataset.id=e.id;const r=document.createElement("div");if(r.className="service-icon",r.style.background=t.bg,t.emoji)r.textContent=t.emoji;else{const u=document.createElement("span");u.className="service-icon-letter",u.textContent=(e.issuer||e.account||"?")[0].toUpperCase(),r.appendChild(u)}const o=document.createElement("div");o.className="account-info",o.innerHTML=`
    <div class="account-issuer">${Te(e.issuer||"Unknown")}</div>
    <div class="account-label">${Te(e.account||"")}</div>
  `;const s=document.createElement("div");s.className="account-code-wrapper";const a=document.createElement("div");a.className="account-code",a.textContent="--- ---";const c=Ao(e.period||30);s.appendChild(a),s.appendChild(c);const l=document.createElement("div");l.className="copy-flash";const d=document.createElement("div");return d.className="card-actions",d.innerHTML=`
    <button class="card-action-btn" data-action="edit" title="Edit">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
    </button>
    <button class="card-action-btn delete" data-action="delete" title="Delete">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>
    </button>
  `,n.appendChild(r),n.appendChild(o),n.appendChild(s),n.appendChild(l),n.appendChild(d),n.addEventListener("click",u=>{u.target.closest("[data-action]")||So(e.id,a,l,n)}),d.addEventListener("click",u=>{const f=u.target.closest("[data-action]");f&&(u.stopPropagation(),f.dataset.action==="edit"&&Mo(e.id),f.dataset.action==="delete"&&No(e.id,e.issuer,e.account))}),n._codeEl=a,n._ringEl=c,n._account=e,n}function Te(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}async function So(e,t,n,r){const o=t.textContent.replace(/\s/g,"");try{await navigator.clipboard.writeText(o),n.classList.remove("animate"),n.offsetWidth,n.classList.add("animate"),r.classList.add("copied"),setTimeout(()=>r.classList.remove("copied"),800),y("Code copied!","success",1500),le(),m.closeAfterCopy&&setTimeout(()=>window.close(),700)}catch{y("Failed to copy","error")}}async function Ie(){m=await no(),X(),A=await T(),K(A),Co(),m.autoFocusSearch&&setTimeout(()=>i("#searchInput")?.focus(),100),await be()}function K(e){const t=i("#accountsList");if(t.innerHTML="",!e||e.length===0){const n=i("#searchInput")?.value||"";t.innerHTML=`
      <div class="accounts-empty">
        <div class="accounts-empty-icon">${n?"üîç":"üîê"}</div>
        <div class="accounts-empty-title">${n?"No results":"No accounts yet"}</div>
        <div class="accounts-empty-sub">${n?`No accounts match "${Te(n)}"`:"Tap the + button to add your first TOTP account"}</div>
      </div>
    `;return}e.forEach(n=>{const r=ko(n);t.appendChild(r)}),pn()}async function pn(){const e=He(".account-card");for(const t of e){const n=t._account;if(!n)continue;const r=zr(n.period||30);try{const o=await Vr(n.secret,{digits:n.digits||6,period:n.period||30,algorithm:n.algorithm||"SHA1"});t._codeEl.textContent=Kr(o),t._codeEl.classList.remove("warning","danger"),r<=5?t._codeEl.classList.add("danger"):r<=10&&t._codeEl.classList.add("warning"),Lo(t._ringEl,r,n.period||30)}catch{t._codeEl.textContent="Error"}}}function Co(){oe&&clearInterval(oe),oe=setInterval(pn,1e3)}function To(){const e=i("#searchInput"),t=i("#searchClear");e.addEventListener("input",async()=>{const n=e.value.trim();t.classList.toggle("visible",n.length>0);const r=await wo(n);K(r),le()}),t.addEventListener("click",()=>{e.value="",t.classList.remove("visible"),K(A),e.focus()})}function Io(){const e=i("#fabBtn"),t=i("#fabMenu");e.addEventListener("click",()=>{const n=t.classList.toggle("open");e.classList.toggle("open",n)}),document.addEventListener("click",n=>{n.target.closest("#fabContainer")||(t.classList.remove("open"),e.classList.remove("open"))}),i("#btnManualEntry").addEventListener("click",()=>{t.classList.remove("open"),e.classList.remove("open"),Pe(),L("#modalAddAccount")}),i("#btnUploadQR").addEventListener("click",()=>{t.classList.remove("open"),e.classList.remove("open");const n=document.createElement("input");n.type="file",n.accept="image/*",n.addEventListener("change",r=>{const o=r.target.files[0];o&&Po(o)}),n.click()}),i("#btnScanQR").addEventListener("click",()=>{t.classList.remove("open"),e.classList.remove("open"),chrome.tabs.create({url:chrome.runtime.getURL("src/scanner/scanner.html")})})}async function Po(e){try{const t=new Image,n=URL.createObjectURL(e);t.src=n,await new Promise((l,d)=>{t.onload=l,t.onerror=d});const r=document.createElement("canvas");r.width=t.naturalWidth,r.height=t.naturalHeight;const o=r.getContext("2d");o.drawImage(t,0,0);const s=o.getImageData(0,0,r.width,r.height);URL.revokeObjectURL(n);let a=null;if("BarcodeDetector"in window)try{const d=await new BarcodeDetector({formats:["qr_code"]}).detect(t);d.length>0&&(a=d[0].rawValue)}catch{}if(!a){y("QR scan failed. Try manual entry.","error"),Pe(),L("#modalAddAccount");return}const c=an(a);gn(c),L("#modalAddAccount")}catch(t){y("Could not read QR code: "+t.message,"error"),Pe(),L("#modalAddAccount")}}function gn(e){i("#addIssuer").value=e.issuer||"",i("#addAccount").value=e.account||"",i("#addSecret").value=e.secret||"",i("#addAlgorithm").value=e.algorithm||"SHA1",i("#addDigits").value=String(e.digits||6),i("#addPeriod").value=String(e.period||30)}function Pe(){i("#addIssuer").value="",i("#addAccount").value="",i("#addSecret").value="",i("#addAlgorithm").value="SHA1",i("#addDigits").value="6",i("#addPeriod").value="30",i("#addSecretError").classList.remove("visible")}function $o(){i("#closeModalAdd").addEventListener("click",()=>b("#modalAddAccount")),i("#modalAddAccount").addEventListener("click",e=>{e.target===e.currentTarget&&b("#modalAddAccount")}),i("#addSecret").addEventListener("blur",()=>{const e=i("#addSecret").value,t=i("#addSecretError");e&&!ke(e)?(i("#addSecret").classList.add("error"),t.classList.add("visible")):(i("#addSecret").classList.remove("error"),t.classList.remove("visible"))}),i("#btnAddAccountSubmit").addEventListener("click",async()=>{const e=i("#addIssuer").value.trim(),t=i("#addAccount").value.trim(),n=i("#addSecret").value.trim(),r=i("#addAlgorithm").value,o=parseInt(i("#addDigits").value),s=parseInt(i("#addPeriod").value);if(!n||!ke(n)){i("#addSecret").classList.add("error"),i("#addSecretError").classList.add("visible");return}if(!t&&!e){y("Please enter an account name or issuer","error");return}try{i("#btnAddAccountSubmit").disabled=!0;const a=await po({issuer:e,account:t,secret:n,algorithm:r,digits:o,period:s},k);A=await T(),K(A),b("#modalAddAccount"),Pe(),y(`${e||t} added!`,"success"),le()}catch(a){y("Failed to add account: "+a.message,"error")}finally{i("#btnAddAccountSubmit").disabled=!1}})}function Mo(e){const t=A.find(n=>n.id===e);t&&(i("#editAccountId").value=t.id,i("#editIssuer").value=t.issuer||"",i("#editAccountName").value=t.account||"",i("#editSecret").value=t.secret||"",i("#editAlgorithm").value=t.algorithm||"SHA1",i("#editDigits").value=String(t.digits||6),L("#modalEditAccount"))}function Do(){i("#closeModalEdit").addEventListener("click",()=>b("#modalEditAccount")),i("#modalEditAccount").addEventListener("click",e=>{e.target===e.currentTarget&&b("#modalEditAccount")}),i("#toggleSecretVisibility").addEventListener("click",()=>{const e=i("#editSecret");e.type=e.type==="password"?"text":"password"}),i("#btnEditAccountSubmit").addEventListener("click",async()=>{const e=i("#editAccountId").value,t=i("#editIssuer").value.trim(),n=i("#editAccountName").value.trim(),r=i("#editSecret").value.trim(),o=i("#editAlgorithm").value,s=parseInt(i("#editDigits").value);if(!r||!ke(r)){y("Invalid secret key","error");return}try{i("#btnEditAccountSubmit").disabled=!0,await go(e,{issuer:t,account:n,secret:r,algorithm:o,digits:s},k),A=await T(),K(A),b("#modalEditAccount"),y("Account updated!","success"),le()}catch(a){y("Failed to update: "+a.message,"error")}finally{i("#btnEditAccountSubmit").disabled=!1}})}let ne=null;function No(e,t,n){ne=e;const r=`Delete <strong>${Te(t||n)}</strong>? This will permanently remove the account and its TOTP secret.`;i("#deleteConfirmText").innerHTML=r,i("#deleteAccountId").value=e,L("#modalDeleteConfirm")}function _o(){i("#btnDeleteCancel").addEventListener("click",()=>{b("#modalDeleteConfirm"),ne=null}),i("#modalDeleteConfirm").addEventListener("click",e=>{e.target===e.currentTarget&&b("#modalDeleteConfirm")}),i("#btnDeleteConfirm").addEventListener("click",async()=>{if(ne)try{await mo(ne,k),A=await T(),K(A),b("#modalDeleteConfirm"),y("Account deleted","info"),ne=null,le()}catch(e){y("Failed to delete: "+e.message,"error")}})}function Bo(){const e=i("#btnProfile"),t=i("#profileMenuOverlay");e.addEventListener("click",()=>{t.classList.toggle("open")&&be()}),t.addEventListener("click",n=>{n.target===t&&t.classList.remove("open")}),i("#btnLoginGoogle").addEventListener("click",async()=>{const n=await ao();n.success?(y(`Welcome, ${n.user.name}!`,"success"),await be(),t.classList.remove("open")):y("Login failed: "+n.error,"error")}),i("#btnLogoutGoogle").addEventListener("click",async()=>{(await io()).success&&(y("Signed out","info"),await be(),t.classList.remove("open"))}),i("#btnBackupToDrive").addEventListener("click",async()=>{t.classList.remove("open"),await bt()}),i("#btnBackupDriveSettings")?.addEventListener("click",async()=>{b("#modalSettings"),await bt()})}async function be(){const e=i("#profileMenuLoggedOut"),t=i("#profileMenuLoggedIn"),n=i("#btnBackupDriveSettings");if(await un()){const o=await oo();if(o){i("#userDisplayName").textContent=o.name,i("#userEmail").textContent=o.email;const s=i("#userProfilePicture");o.picture?(s.src=o.picture,s.style.display="block"):s.style.display="none";const a=i("#profileAvatar");o.picture&&(a.innerHTML=`<img src="${o.picture}" alt="Profile" />`)}e.style.display="none",t.style.display="block",n&&(n.style.display="flex")}else e.style.display="block",t.style.display="none",n&&(n.style.display="none"),i("#profileAvatar").innerHTML=`
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
        <circle cx="12" cy="7" r="4"/>
      </svg>
    `}async function bt(){if(!await un()){y("Please sign in with Google first","error");return}y("Backing up to Drive...","info");const e=await uo(A);e.success?y(`Backup saved: ${e.fileName}`,"success",3e3):y("Backup failed: "+e.error,"error")}function Oo(){i("#btnSettings").addEventListener("click",()=>{X(),L("#modalSettings")}),i("#closeModalSettings").addEventListener("click",()=>b("#modalSettings")),i("#modalSettings").addEventListener("click",e=>{e.target===e.currentTarget&&b("#modalSettings")}),i("#pinProtectionToggle").addEventListener("change",async e=>{const t=e.target.checked;if(t&&!await it()){b("#modalSettings"),Ho();return}m.pinEnabled=t,await Se(t),X(),y(t?"PIN protection enabled":"PIN protection disabled","info")}),i("#privacyModeToggle").addEventListener("change",async e=>{m.privacyMode=e.target.checked,await Q("privacyMode",m.privacyMode),X()}),i("#compactLayoutToggle").addEventListener("change",async e=>{m.compactLayout=e.target.checked,await Q("compactLayout",m.compactLayout),X()}),i("#closeAfterCopyToggle").addEventListener("change",async e=>{m.closeAfterCopy=e.target.checked,await Q("closeAfterCopy",m.closeAfterCopy)}),i("#autoFocusSearchToggle").addEventListener("change",async e=>{m.autoFocusSearch=e.target.checked,await Q("autoFocusSearch",m.autoFocusSearch)}),i("#autoLockSelect").addEventListener("change",async e=>{m.autoLockMinutes=parseInt(e.target.value),await Q("autoLockMinutes",m.autoLockMinutes),ct()}),He("#accentColorPicker .color-swatch").forEach(e=>{e.addEventListener("click",async()=>{const t=e.dataset.color;m.accentColor=t,await Q("accentColor",t),X()})}),i("#btnLockNow").addEventListener("click",async()=>{await ho(),k=null,b("#modalSettings"),U("#viewLock"),oe&&clearInterval(oe)}),i("#btnChangePIN").addEventListener("click",()=>{i("#currentPin").value="",i("#newPin").value="",i("#confirmNewPin").value="",i("#changePinError").classList.remove("visible"),L("#modalChangePin")}),i("#closeModalChangePin").addEventListener("click",()=>b("#modalChangePin")),i("#btnChangePinConfirm").addEventListener("click",async()=>{const e=i("#currentPin").value,t=i("#newPin").value,n=i("#confirmNewPin").value,r=i("#changePinError");if(t.length<4){r.textContent="PIN must be at least 4 digits",r.classList.add("visible");return}if(t!==n){r.textContent="New PINs do not match",r.classList.add("visible");return}try{const o=await S("pinData");if(!await sn(e,o.hash,o.salt)){r.textContent="Current PIN is incorrect",r.classList.add("visible");return}const a=await _e(),c=await at(t);if(await j("pinData",c),a){const l=JSON.stringify(a),d=await Ne(l,t);await j("vault",d)}k=t,b("#modalChangePin"),y("PIN updated successfully!","success")}catch(o){r.textContent="Failed: "+o.message,r.classList.add("visible")}}),i("#btnExportData").addEventListener("click",()=>{i("#exportPassword").value="",i("#exportPasswordConfirm").value="",i("#exportPasswordError").classList.remove("visible"),L("#modalExportPassword")}),i("#closeModalExport").addEventListener("click",()=>b("#modalExportPassword")),i("#btnExportConfirm").addEventListener("click",async()=>{const e=i("#exportPassword").value,t=i("#exportPasswordConfirm").value,n=i("#exportPasswordError");if(!e){n.textContent="Please enter a password",n.classList.add("visible");return}if(e!==t){n.textContent="Passwords do not match",n.classList.add("visible");return}try{i("#btnExportConfirm").disabled=!0;const r=await yo(e),o=new Blob([r],{type:"application/json"}),s=URL.createObjectURL(o),a=document.createElement("a");a.href=s,a.download=`azkura-backup-${new Date().toISOString().slice(0,10)}.json`,a.click(),URL.revokeObjectURL(s),b("#modalExportPassword"),y("Backup exported!","success")}catch(r){n.textContent="Export failed: "+r.message,n.classList.add("visible")}finally{i("#btnExportConfirm").disabled=!1}}),i("#importFileInput").addEventListener("change",e=>{Z=e.target.files[0],Z&&(i("#importPassword").value="",i("#importPasswordError").classList.remove("visible"),i("#importFileInfo").textContent=`File: ${Z.name}. Enter the backup password.`,L("#modalImportPassword"),e.target.value="")}),i("#closeModalImport").addEventListener("click",()=>b("#modalImportPassword")),i("#btnImportConfirm").addEventListener("click",async()=>{if(!Z)return;const e=i("#importPassword").value,t=i("#importPasswordError");if(!e){t.textContent="Please enter the backup password",t.classList.add("visible");return}try{i("#btnImportConfirm").disabled=!0;const n=await Z.text(),r=await bo(n,e,k);A=await T(),K(A),b("#modalImportPassword"),b("#modalSettings"),y(`Imported ${r.imported} account(s)!`,"success"),Z=null}catch(n){t.textContent=n.message,t.classList.add("visible")}finally{i("#btnImportConfirm").disabled=!1}}),i("#btnDeleteAll").addEventListener("click",()=>{i("#deleteAllConfirmInput").value="",i("#btnDeleteAllConfirm").disabled=!0,L("#modalDeleteAll")}),i("#btnDeleteAllCancel").addEventListener("click",()=>b("#modalDeleteAll")),i("#deleteAllConfirmInput").addEventListener("input",e=>{i("#btnDeleteAllConfirm").disabled=e.target.value!=="DELETE"}),i("#btnDeleteAllConfirm").addEventListener("click",async()=>{if(i("#deleteAllConfirmInput").value==="DELETE")try{await vo(),A=[],k=null,b("#modalDeleteAll"),b("#modalSettings"),y("All data deleted","info",2e3),setTimeout(()=>{U("#viewOnboarding"),hn()},500)}catch(e){y("Failed to delete: "+e.message,"error")}})}async function Ho(){i("#currentPin").closest(".form-group").style.display="none",i("#newPin").placeholder="Create PIN",i("#confirmNewPin").placeholder="Confirm PIN",i("#changePinError").classList.remove("visible"),i("#btnChangePinConfirm").onclick,i("#btnChangePinConfirm").onclick=async()=>{const e=i("#newPin").value,t=i("#confirmNewPin").value,n=i("#changePinError");if(e.length<4){n.textContent="PIN must be at least 4 digits",n.classList.add("visible");return}if(e!==t){n.textContent="PINs do not match",n.classList.add("visible");return}try{const r=await at(e);await j("pinData",r),await Se(!0),m.pinEnabled=!0,k=e;const o=await _e();if(o){const s=JSON.stringify(o),a=await Ne(s,e);await j("vault",a)}b("#modalChangePin"),y("PIN protection enabled!","success"),X(),setTimeout(()=>{i("#currentPin").closest(".form-group").style.display="block",i("#newPin").placeholder="",i("#confirmNewPin").placeholder=""},300)}catch(r){n.textContent="Failed: "+r.message,n.classList.add("visible")}},L("#modalChangePin")}async function Ro(){hn(),Eo(),To(),Io(),$o(),Do(),_o(),Oo(),Bo();const e=await to(),t=await it(),n=await Zr(),r=await eo();e?U("#viewOnboarding"):t&&n&&!r?U("#viewLock"):(k=null,r||await Ce(null),U("#viewMain"),await Ie(),n&&ct()),chrome.storage.session.get("pendingQR",async o=>{if(o.pendingQR){chrome.storage.session.remove("pendingQR");const s=an(o.pendingQR);gn(s),L("#modalAddAccount")}})}Ro().catch(console.error);
