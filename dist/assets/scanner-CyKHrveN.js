import"./modulepreload-polyfill-B5Qt9EMX.js";const c=document.getElementById("video"),i=document.getElementById("canvas"),o=document.getElementById("statusTextCamera"),n=document.getElementById("statusTextUpload"),v=document.getElementById("permissionError"),h=document.getElementById("videoWrapper"),w=document.getElementById("fileInput"),r=document.getElementById("uploadArea");let a=null,l=!1;window.switchTab=function(t){document.querySelectorAll(".tab").forEach(e=>e.classList.remove("active")),document.querySelectorAll(".tab-content").forEach(e=>e.classList.remove("active")),document.getElementById(`tab${t.charAt(0).toUpperCase()+t.slice(1)}`).classList.add("active"),document.getElementById(`content${t.charAt(0).toUpperCase()+t.slice(1)}`).classList.add("active"),t!=="camera"&&a&&(a.getTracks().forEach(e=>e.stop()),a=null,l=!1),t==="camera"&&!a&&startScanner()};window.startScanner=async function(){v.classList.remove("visible"),h.style.display="block",o.textContent="Initializing camera...";try{a=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:"environment"},width:{ideal:1280},height:{ideal:720}}}),c.srcObject=a,await c.play(),l=!0,o.textContent="Scanning for QR code...",requestAnimationFrame(g)}catch(t){t.name==="NotAllowedError"||t.name==="PermissionDeniedError"?(o.textContent="",h.style.display="none",v.classList.add("visible")):(o.textContent="Camera error: "+t.message,o.className="status-text error")}};async function g(){if(!l)return;if(c.readyState<c.HAVE_ENOUGH_DATA){requestAnimationFrame(g);return}i.width=c.videoWidth,i.height=c.videoHeight,i.getContext("2d").drawImage(c,0,0);let e=null;if("BarcodeDetector"in window)try{const m=await new BarcodeDetector({formats:["qr_code"]}).detect(c);m.length>0&&(e=m[0].rawValue)}catch{}if(e){p(e,"camera");return}requestAnimationFrame(g)}r.addEventListener("click",()=>w.click());r.addEventListener("dragover",t=>{t.preventDefault(),r.style.borderColor="var(--accent)",r.style.background="rgba(0,229,255,0.1)"});r.addEventListener("dragleave",()=>{r.style.borderColor="",r.style.background=""});r.addEventListener("drop",t=>{t.preventDefault(),r.style.borderColor="",r.style.background="";const e=t.dataTransfer.files[0];e&&e.type.startsWith("image/")&&y(e)});w.addEventListener("change",t=>{const e=t.target.files[0];e&&y(e)});async function y(t){n.textContent="Processing image...",n.className="status-text";try{const e=new Image,s=URL.createObjectURL(t);e.src=s,await new Promise((f,d)=>{e.onload=f,e.onerror=()=>d(new Error("Failed to load image"))}),i.width=e.naturalWidth,i.height=e.naturalHeight,i.getContext("2d").drawImage(e,0,0),URL.revokeObjectURL(s);let u=null;if("BarcodeDetector"in window)try{const d=await new BarcodeDetector({formats:["qr_code"]}).detect(e);d.length>0&&(u=d[0].rawValue)}catch{}u?p(u,"upload"):(n.textContent="⚠ No QR code found in image",n.className="status-text error")}catch(e){n.textContent="Error: "+e.message,n.className="status-text error"}}function p(t,e){if(l=!1,a&&(a.getTracks().forEach(s=>s.stop()),a=null),!t.startsWith("otpauth://")){const s="⚠ QR code found, but not a valid TOTP code";e==="camera"?(o.textContent=s,o.className="status-text error",setTimeout(startScanner,2e3)):(n.textContent=s,n.className="status-text error");return}chrome.runtime.sendMessage({type:"QR_SCANNED",data:t}),e==="camera"?(o.textContent="✓ Account added! Closing...",o.className="status-text success"):(n.textContent="✓ Account added! Closing...",n.className="status-text success"),setTimeout(()=>window.close(),1500)}const E=new URLSearchParams(window.location.search),x=E.get("tab");x==="upload"?switchTab("upload"):document.getElementById("contentCamera").classList.contains("active")&&startScanner();window.addEventListener("beforeunload",()=>{a&&a.getTracks().forEach(t=>t.stop())});
